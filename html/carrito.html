<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de Compras - Tienda Barbería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
</head>

<body class="bg-gray-100">
    <header>
        <nav class="bg-blue-800">
            <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
                <div class="relative flex h-16 items-center justify-between">
                    <div class="absolute inset-y-0 left-0 flex items-center sm:hidden">
                        <button type="button" data-collapse-toggle="mobile-menu"
                            class="relative inline-flex items-center justify-center rounded-md p-2 text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
                            aria-controls="mobile-menu" aria-expanded="false">
                            <span class="absolute -inset-0.5"></span>
                            <span class="sr-only">Open main menu</span>
                            <svg class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" aria-hidden="true" data-slot="icon">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                            </svg>
                            <svg class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" aria-hidden="true" data-slot="icon">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex flex-1 items-center justify-center sm:items-stretch sm:justify-start">
                        <div class="flex flex-shrink-0 items-center">
                            <img class="h-8 w-auto" src="/img/logo2.png" alt="Tienda Barbería">
                        </div>
                        <div class="hidden sm:ml-6 sm:block">
                            <div class="hidden sm:ml-6 sm:block">
                                <div class="flex space-x-4">
                                    <a href="index.html"
                                        class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Inicio</a>
                                    <a href="productos.html"
                                        class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Productos</a>
                                    <a href="nosotros.html"
                                        class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Nosotros</a>
                                    <a href="contacto.html"
                                        class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Contacto</a>
                                    <a href="blog.html"
                                        class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Blog</a>
                                    <a href="login.html" id="loginLink"
                                        class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Login</a>
                                    <a href="perfil.html" id="perfilLink"
                                        class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white hidden">Perfil</a>
                                    <a href="carrito.html"
                                        class="rounded-md bg-gray-900 px-3 py-2 text-sm font-medium text-white"
                                        aria-current="page">Carrito</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sm:hidden" id="mobile-menu">
                    <div class="hidden sm:ml-6 sm:block">
                        <div class="flex space-x-4">
                            <a href="index.html" class="rounded-md bg-gray-900 px-3 py-2 text-sm font-medium text-white"
                                aria-current="page">Inicio</a>
                            <a href="productos.html"
                                class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Productos</a>
                            <a href="nosotros.html"
                                class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Nosotros</a>
                            <a href="contacto.html"
                                class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Contacto</a>
                            <a href="blog.html"
                                class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Blog</a>
                            <a href="login.html" id="loginLink"
                                class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Login</a>
                            <a href="perfil.html" id="perfilLink"
                                class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white hidden">Perfil</a>

                            <a href="carrito.html"
                                class="rounded-md px-3 py-2 text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white">Carrito</a>
                        </div>
                    </div>
        </nav>
    </header>

    <section class="container mx-auto p-6 mt-8 bg-white rounded-lg shadow-md">
        <h2 class="text-4xl font-extrabold text-center mb-4 text-blue-700">Carrito de Compras</h2>
        <p class="text-gray-700 text-lg text-center mb-6">Aquí están los productos que has agregado a tu carrito.</p>

        <div id="carrito-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        </div>

        <div id="subtotal-container" class="mt-6 text-lg font-semibold text-right">
            Subtotal: $<span id="subtotal">0.00</span>
        </div>

        <div class="mt-6">
            <button id="comprar-btn"
                class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">Comprar</button>
        </div>
    </section>

    <footer class="bg-blue-600 text-white p-4 text-center mt-8">
        <p>&copy; 2024 Tienda Barbería. Todos los derechos reservados.</p>
        <p>Encuéntranos en nuestras redes sociales:</p>
        <div class="flex justify-center space-x-4 mt-2">
            <a href="#" class="hover:text-blue-300">Facebook</a>
            <a href="#" class="hover:text-blue-300">Instagram</a>
            <a href="#" class="hover:text-blue-300">Twitter</a>
        </div>
    </footer>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const carritoContainer = document.getElementById("carrito-container");
            const subtotalContainer = document.getElementById("subtotal");
            const comprarBtn = document.getElementById("comprar-btn");
            const carrito = JSON.parse(localStorage.getItem("carrito")) || [];

            let subtotal = 0;

            if (carrito.length === 0) {
                carritoContainer.innerHTML = `<p class="text-center text-gray-500">El carrito está vacío.</p>`;
                return;
            }

            function actualizarSubtotal() {
                subtotalContainer.textContent = subtotal.toFixed(2);
            }

            carrito.forEach((producto) => {
                const productoCard = document.createElement("div");
                productoCard.className = "bg-white p-4 rounded-lg shadow-md flex flex-col";

                const precioProducto = parseFloat(producto.pro_precio);
                subtotal += precioProducto * producto.cantidad;

                productoCard.innerHTML = `
                    <img src="${producto.pro_ruta}" alt="${producto.pro_nombre}" class="w-full h-auto max-h-48 object-contain rounded-t-md">
                    <h3 class="text-xl font-semibold mt-4">${producto.pro_nombre}</h3>
                    <p class="text-gray-600 mt-2">${producto.pro_descripcion}</p>
                    <p class="text-lg font-bold text-blue-600 mt-2">$${precioProducto.toFixed(2)}</p>
                    <p class="mt-2">Cantidad: <input type="number" value="${producto.cantidad}" min="1" data-id="${producto.pro_id}" class="cantidad-input border border-gray-400 rounded px-2 w-16 text-center"></p>
                    <button class="eliminar-btn mt-4 bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700" data-id="${producto.pro_id}">Eliminar</button>
                `;

                carritoContainer.appendChild(productoCard);
            });

            actualizarSubtotal();

            carritoContainer.addEventListener('input', (event) => {
                if (event.target.classList.contains('cantidad-input')) {
                    const productoId = event.target.getAttribute('data-id');
                    const nuevaCantidad = parseInt(event.target.value);
                    const producto = carrito.find(producto => producto.pro_id == productoId);

                    if (producto) {
                        producto.cantidad = nuevaCantidad > 0 ? nuevaCantidad : 1;
                        localStorage.setItem('carrito', JSON.stringify(carrito));
                        subtotal = carrito.reduce((total, p) => total + (parseFloat(p.pro_precio) * p.cantidad), 0);
                        actualizarSubtotal();
                    }
                }
            });

            // Eliminar producto
            carritoContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('eliminar-btn')) {
                    const productoId = event.target.getAttribute('data-id');
                    const nuevoCarrito = carrito.filter(producto => producto.pro_id != productoId);
                    localStorage.setItem('carrito', JSON.stringify(nuevoCarrito));
                    location.reload();
                }
            });

            const { jsPDF } = window.jspdf;

            comprarBtn.addEventListener('click', async () => {
                const carrito = JSON.parse(localStorage.getItem('carrito')) || [];

                if (carrito.length === 0) {
                    alert("El carrito está vacío. No se puede realizar la compra.");
                    return;
                }

                const stockResponse = await fetch('http://localhost:3000/reducir-stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(carrito),
                });

                if (stockResponse.ok) {
                    const pdf = new jsPDF();

                    pdf.setFontSize(16);
                    pdf.setTextColor(22, 160, 133);
                    pdf.text("Factura de Compra", 20, 20);
                    pdf.setFontSize(12);
                    pdf.setTextColor(0, 0, 0);

                    pdf.autoTable({
                        head: [['Nombre del Producto', 'Descripción', 'Precio', 'Cantidad', 'Subtotal']],
                        body: carrito.map(producto => {
                            const precioProducto = parseFloat(producto.pro_precio);
                            const totalProducto = precioProducto * producto.cantidad;
                            return [
                                producto.pro_nombre,
                                producto.pro_descripcion,
                                `$${precioProducto.toFixed(2)}`,
                                producto.cantidad,
                                `$${totalProducto.toFixed(2)}`
                            ];
                        }),
                        startY: 30,
                        margin: { horizontal: 10 },
                        theme: 'grid',
                        styles: {
                            fontSize: 10,
                            cellPadding: 4,
                            lineColor: [22, 160, 133],
                            lineWidth: 0.75,
                        },
                        headStyles: {
                            fillColor: [22, 160, 133],
                            textColor: [255, 255, 255],
                            fontSize: 12,
                            halign: 'center',
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245],
                        },
                        columnStyles: {
                            0: { halign: 'left' },
                            1: { halign: 'left' },
                            2: { halign: 'right' },
                            3: { halign: 'center' },
                            4: { halign: 'right' },
                        },
                    });

                    const subtotal = carrito.reduce((total, p) => total + (parseFloat(p.pro_precio) * p.cantidad), 0);
                    const iva = subtotal * 0.15;
                    const total = subtotal + iva;

                    const y = pdf.autoTable.previous.finalY + 10;
                    pdf.setTextColor(22, 160, 133);
                    pdf.text(`Subtotal: $${subtotal.toFixed(2)}`, 20, y);
                    pdf.text(`IVA (15%): $${iva.toFixed(2)}`, 20, y + 10);
                    pdf.text(`Total: $${total.toFixed(2)}`, 20, y + 20);

                    pdf.save('factura_compra.pdf');

                    alert("Compra realizada con éxito");
                    localStorage.removeItem('carrito');
                    location.reload();
                } else {
                    alert("Error al procesar la compra");
                }
            });



        });
    </script>
    <script>
        function toggleLoginPerfil() {
            const loginLink = document.getElementById('loginLink');
            const perfilLink = document.getElementById('perfilLink');

            if (localStorage.getItem('usuario')) {
                perfilLink.classList.remove('hidden');
                loginLink.classList.add('hidden');
            } else {
                perfilLink.classList.add('hidden');
                loginLink.classList.remove('hidden');
            }
        }

        window.onload = toggleLoginPerfil;
    </script>

</body>

</html>